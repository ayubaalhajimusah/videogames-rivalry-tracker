{% extends "base.html" %}
{% block title %}Record Match - PES Tracker{% endblock %}

{% block content %}
  <div class="card">
    <h2>Record Match</h2>
    <p class="muted">Pick players, enter teams + scores, then save.</p>

    <label class="muted">Player 1</label>
    <select id="player1"></select>

    <label class="muted">Team (Player 1)</label>
    <input type="text" id="team1" placeholder="e.g. Liverpool">

    <label class="muted">Score (Player 1)</label>
    <input type="number" id="score1" placeholder="e.g. 2" min="0">

    <hr style="border:0; border-top:1px solid #eee; margin:14px 0;">

    <label class="muted">Player 2</label>
    <select id="player2"></select>

    <label class="muted">Team (Player 2)</label>
    <input type="text" id="team2" placeholder="e.g. Inter Milan">

    <label class="muted">Score (Player 2)</label>
    <input type="number" id="score2" placeholder="e.g. 1" min="0">

    <button class="btn btn-primary" type="button" onclick="recordMatch()">
      ✅ Record Match
    </button>

    <p id="message" class="muted" style="margin-top:12px;"></p>
  </div>

  <div class="card">
    <h3>Tip</h3>
    <p class="muted">If you make a mistake, you can move a match to the bin from the Matches page and restore it later. Designed and coded by Tamale Zaa Musah</p>
  </div>

  <script>
    async function loadPlayers() {
      const response = await fetch("/players/");
      const players = await response.json();

      const p1 = document.getElementById("player1");
      const p2 = document.getElementById("player2");

      p1.innerHTML = "";
      p2.innerHTML = "";

      players.forEach(player => {
        const option1 = document.createElement("option");
        option1.value = player.id;
        option1.text = player.name;
        p1.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = player.id;
        option2.text = player.name;
        p2.appendChild(option2);
      });
    }

    async function recordMatch() {
      const player1_id = document.getElementById("player1").value;
      const player2_id = document.getElementById("player2").value;

      const player1_team = document.getElementById("team1").value.trim();
      const player2_team = document.getElementById("team2").value.trim();

      const player1_score = document.getElementById("score1").value;
      const player2_score = document.getElementById("score2").value;

      const msg = document.getElementById("message");
      msg.className = "muted";
      msg.innerText = "";

      if (player1_id === player2_id) {
        msg.className = "error";
        msg.innerText = "Players must be different.";
        return;
      }

      if (!player1_team || !player2_team) {
        msg.className = "error";
        msg.innerText = "Please enter both teams.";
        return;
      }

      if (player1_score === "" || player2_score === "") {
        msg.className = "error";
        msg.innerText = "Please enter both scores.";
        return;
      }

      const response = await fetch(
        `/matches/?player1_id=${player1_id}&player2_id=${player2_id}` +
        `&player1_score=${player1_score}&player2_score=${player2_score}` +
        `&player1_team=${encodeURIComponent(player1_team)}&player2_team=${encodeURIComponent(player2_team)}`,
        { method: "POST" }
      );

      const data = await response.json();

      if (response.ok) {
        msg.className = "success";
        msg.innerText = "Match recorded successfully ✅";

        document.getElementById("team1").value = "";
        document.getElementById("team2").value = "";
        document.getElementById("score1").value = "";
        document.getElementById("score2").value = "";
      } else {
        msg.className = "error";
        msg.innerText = data.detail || "Error recording match.";
      }
    }

    loadPlayers();
  </script>
{% endblock %}
